name: CICDCFT
on:
  push:
    branches:
      - main
    path:
      - deploy/**
    paths-ignore:
      - .github/**
      - document/**
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
      with:
          fetch-depth: 0
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v33
 
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 # Use your bucket region here
 
 
  # Ensure the file exists before running the loop
if [[ -f "Document/stack-name.txt" ]]; then
  # Read each line from the file and process it
  while IFS= read -r file; do
    # Extract the stack name from the file path
    stack_name=$(echo $file | cut -f2 -d'/' | cut -f1 -d'.')
    
    # Check if the extracted stack name is valid (non-empty)
    if [[ -n "$stack_name" ]]; then
      # Deploy using AWS CloudFormation
      echo "Deploying stack: $stack_name"
      aws cloudformation deploy --template $file --stack-name $stack_name || exit 1
    else
      echo "Error: Could not extract stack name from $file"
      exit 1
    fi
  done < "Document/stack-name.txt"
else
  echo "Error: File 'Document/stack-name.txt' does not exist"
  exit 1
fi

 
